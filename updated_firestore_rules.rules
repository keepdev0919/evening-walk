rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // 1. 기존 사용자 정보 규칙 (변경 없음)
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // 2. 산책 세션 서브컬렉션 규칙 (새로 추가)
      match /walk_sessions/{sessionId} {
        // 사용자는 자신의 서브컬렉션에만 접근 가능
        // userId 필드가 없어도 경로로 소유권 확인
        allow read, write: if request.auth != null && request.auth.uid == userId;
        allow create: if request.auth != null && request.auth.uid == userId;
        allow update: if request.auth != null && request.auth.uid == userId;
        allow delete: if request.auth != null && request.auth.uid == userId;
      }
    }

    // 3. 기존 walk_sessions 컬렉션 규칙 (기존 데이터 호환용)
    match /walk_sessions/{sessionId} {
      // 인증된 사용자만 자신이 생성한 산책 기록을 읽고 쓸 수 있음
      allow read, update: if request.auth != null &&
        request.auth.uid == resource.data.userId;

      // 생성: 새로 생성할 문서의 userId와 일치하는 사용자만
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.userId;
        
      // 삭제: 자신이 생성한 문서만 삭제 가능
      allow delete: if request.auth != null &&
          request.auth.uid == resource.data.userId;
    }
  }
}